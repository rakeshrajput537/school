<html lang="en">
    <head>
        <title>Student Registration</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="stylesheet" href="css/bootstrap.min.css" />
        <link rel="stylesheet" href="css/style.css" />
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
        <script src="js/popper.min.js"></script>
        <script type="text/javascript" src="js/slim.kickstart.min.js"></script>
        <script src="js/bootstrap.min.js"></script>
        <link rel="stylesheet" href="css/slim.min.css" />
        <link rel="stylesheet" href="css/card.css" />
        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-146572578-1"></script>
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag() {
                dataLayer.push(arguments);
            }
            gtag("js", new Date());

            gtag("config", "UA-146572578-1");
        </script>

        <style>
            .checkbox input[type="checkbox"] {
                width: 20px !important;
            }

            .checkbox label {
                margin-left: 10px;
            }
          
        </style>
    </head>

    <body>
        <div class="formWrap">
            <div class="container">
                <form action="" method="POST" class="registerationForm" id="registrationform">
                    <h1>Fields marked with <span class="required">*</span> are mandatory</h1>
                    <div class="row">
                        <div class="col-lg-12">
                            <div id="divError" runat="server" style="display: none;" class="alert alert-danger" role="alert">
                                <label id="lblExMessage" runat="server"></label>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6">
                            <div class="form-group">
                                <label for="">Name <span class="required">*</span></label>
                                <input class="" required type="text" id="name" name="last_name" />
                            </div>
                        </div>

                        <div class="col-sm-6">
                            <div class="form-group">
                                <label for="">Father Name <span class="required">*</span></label>
                                <input class="" type="text" required id="father_name" name="father_name" />
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-sm-6">
                            <div class="form-group">
                                <label for="">Class <span class="required">*</span></label>
                                <input class="" type="text" required id="class" name="class" />
                            </div>
                        </div>

                        <div class="col-sm-6">
                            <div class="form-group">
                                <label for="">Mobile No <span class="required">*</span></label>
                                <input class="" type="text" required id="mobile_no" name="mobile_no" />
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-lg-6">
                            <div class="form-group">
                                <label for="">Address <span class="required">*</span></label>
                                <input class="" type="text" required id="address" name="address" />
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="form-group">
                                <label for="">Date of Birth <span class="required">*</span></label>
                                <input class="" type="text" required id="dob" name="dob" />
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="form-group">
                                <label for="">Photo <span class="required">*</span></label>
                                <small class="">Upload, (JPEG, JPG, PNG)</small>
                                <div class="row">
                                    <div class="col-sm-12">
                                        <div class="slim" data-force-type="jpg" data-size="600,600">
                                            <input
                                                type="file"
                                                name="CardBack[]"
                                                id="photo"
                                                style="min-height: inherit !important;"
                                                
                                                required
                                                capture
                                            />
                                        </div>
                                    </div>
                                    
                                </div>
                                <div class="row">
                                    <div class="col-sm-12">
                                        <asp:Label ForeColor="Red" runat="server" ID="lblCardBack" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-sm-12">
                            <div class="form-group text-right">
                                <button class="btn btn-primary" sendMessage() type="submit" id="btnSubmit">Submit</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <div class="cards">
                <button class="downloadButton">DownloadImage</button>
            </div>
        </div>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/dom-to-image/2.6.0/dom-to-image.min.js"></script>
        <script>
            function showError(control) {
                switch (control) {
                    case "CardFront":
                        jQuery("#lblCardFront").html("Please select");
                        break;
                    case "CardBack":
                        jQuery("#lblCardBack").html("Please select");
                        break;
                    default:
                        jQuery("#lblCardFront").html("");
                        jQuery("#lblCardBack").html("");
                        break;
                }
            }
        </script>
        <script type="text/javascript">
            noBack();
            window.onload = noBack;
            window.onpageshow = function (evt) {
                if (evt.persisted) noBack();
            };
            window.onunload = function () {
                void 0;
            };
            function noBack() {
                window.history.forward();
            }
        </script>
        <script type="text/javascript">
            $(document).ready(function () {
                $("#divOtherMediaType").hide();
                $("#ddlMediaType").change(function () {
                    var selectedIndex = parseInt(this.selectedIndex);
                    if (selectedIndex == "13") {
                        $("#divOtherMediaType").show();
                        ValidatorEnable(document.getElementById("rfvOtherMediaType"), true);
                    } else {
                        $("#divOtherMediaType").hide();
                        ValidatorEnable(document.getElementById("rfvOtherMediaType"), false);
                    }
                });

                $("#ddlCountry").change(function () {
                    var selectedIndex = parseInt($(this).val());
                    $("#ddlMobileCountry").val(selectedIndex);
                    $("#ddlOfficeCountry").val(selectedIndex);
                    $("#ddlFaxCountry").val(selectedIndex);

                    if (selectedIndex == "1") {
                        $("#fax-area").show();
                        $("#txtMobileNumber").prop("maxLength", 9);
                        $("#txtOfficeNumber").val("");
                        $("#txtOfficeNumber").prop("maxLength", 8);
                    } else {
                        $("#fax-area").show();
                        $("#txtMobileNumber").prop("maxLength", 15);
                        $("#txtOfficeNumber").val("");
                        $("#txtOfficeNumber").prop("maxLength", 15);
                    }
                });
            });
            $(document).on("input", "#mobile_no", function () {
                this.value = this.value.replace(/\D/g, "");
            });
        </script>
        <!-- The core Firebase JS SDK is always required and must be listed first -->
        <script src="https://www.gstatic.com/firebasejs/7.14.1/firebase-app.js"></script>

        <!-- TODO: Add SDKs for Firebase products that you want to use
     https://firebase.google.com/docs/web/setup#available-libraries -->
        <script src="https://www.gstatic.com/firebasejs/7.14.1/firebase-analytics.js"></script>

        <script src="https://www.gstatic.com/firebasejs/7.14.1/firebase-storage.js"></script>

        <script src="https://www.gstatic.com/firebasejs/7.14.1/firebase-database.js"></script>
		
		<script src="js/html2canvas.min.js"></script>
		
        <script>
            // Your web app's Firebase configuration
            const firebaseConfig = {
                // apiKey: "AIzaSyDOm3rX-wfacVlowTvx9VPh-GeiSLcfTNQ",
                // authDomain: "registration-f00f7.firebaseapp.com",
                // databaseURL: "https://registration-f00f7.firebaseio.com",
                // projectId: "registration-f00f7",
                // storageBucket: "registration-f00f7.appspot.com",
                // messagingSenderId: "1069856016035",
                // appId: "1:1069856016035:web:1978d6f9166f7415c42116",
                // measurementId: "G-WKK04Z5CKJ",

                apiKey: "AIzaSyATpKhXpkKbVJyFcW1bgxSKtFcczfeEypc",
                authDomain: "gaytree-mandir.firebaseapp.com",
                databaseURL: "https://gaytree-mandir.firebaseio.com",
                projectId: "gaytree-mandir",
                storageBucket: "gaytree-mandir.appspot.com",
                messagingSenderId: "295563620080",
                appId: "1:295563620080:web:4cb2fcbf1aa732c04d1c35",
                measurementId: "G-HDD1VFWSHK",
            };
            // Initialize Firebase
            firebase.initializeApp(firebaseConfig);
            //firebase.analytics();

            //listen for submit event//(1)
            document.getElementById("registrationform").addEventListener("submit", formSubmit);

            //Submit form(1.2)
            function formSubmit(e) {
                e.preventDefault();
                //Get Values from the DOM
                let name = document.querySelector("#name").value;
                let father_name = document.querySelector("#father_name").value;
                let classname = document.querySelector("#class").value;
                let mobile_no = document.querySelector("#mobile_no").value;
                let address = document.querySelector("#address").value;
                let dob = document.querySelector("#dob").value;

                sendPhoto(name, father_name, classname, mobile_no, address, dob);

                //Show Alert Message(5)
                document.querySelector(".alert").style.display = "block";

                //Hide Alert Message After Seven Seconds(6)
                setTimeout(function () {
                    document.querySelector(".alert").style.display = "none";
                }, 7000);

                //Form Reset After Submission(7)
                document.getElementById("registrationform").reset();
            }

            //Send Message to Firebase(4)
            let db = firebase.database();
            function sendMessage(name, father_name, classname, mobile_no, address,dob, downloadURL, cardImage) {
            	
                key = db.ref("students").push().getKey();
                console.log(key);
                db.ref("students/" + key).set({
                    name: name,
                    father_name: father_name,
                    classname: classname,
                    mobile_no: mobile_no,
                    address: address,
                    dob : dob,
                    img: downloadURL,
                    cardUrl: cardImage,
                });
                
            }

            let fileUpload = document.getElementById("photo");
            
            let firstFile;
            let firstFile64;
           
            
            let storageRef = firebase.storage().ref("profilePictures/");
            
            //listen on change on file input to set the file
            fileUpload.addEventListener("change", function (evt) {
                console.log(evt);
                firstFile = evt.target.files[0]; // upload the first file only
                readFile()
            });

            function sendPhoto(name, father_name, classname, mobile_no, address, dob) {
                // Create file metadata including the content type
                const metadata = {
                    contentType: "image/jpeg",
                
                };
                // Upload the file and metadata to the firebase
                var uploadTask = storageRef.child(firstFile.name).put(firstFile, metadata);
				
                uploadTask.on(
                    "state_changed",
                    function (snapshot) {
                        // Observe state change events such as progress, pause, and resume
                        // Get task progress, including the number of bytes uploaded and the total number of bytes to be uploaded
                        // this can be deleted or used to show some progress bar
                        var progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        console.log("Upload is " + progress + "% done");
                    },
                    function (error) {
                        // Handle unsuccessful uploads
                    },
                    function () {
                        // Handle successful uploads on complete
                        // For instance, get the download URL: https://firebasestorage.googleapis.com/...
                        uploadTask.snapshot.ref.getDownloadURL().then(function (downloadURL) {
                            //this is the card markup
                            const card = `<div class="card-div" >
                    <div class="top-part">
                        MAA BHAGWATI SHIKSHAN SANSTHAN
                    </div>
                    <div class="yellow-part">
                        <img
                            src="./images/akhandJyoti.jpeg"
                            alt=""
                            height="10"
                        />
                        Nandana,Rath-Hamirpur
                        <img
                        src="./images/akhandJyoti.jpeg"
                            alt=""
                            height="10"
                        />
                    </div>
                    <div class="id">
                        Mo- 9454140386
                    </div>
                    <div class="image">
                        <img
                            src="${firstFile64}"
                            alt="profile picture"
                            
                        />
                    </div>
                    <h2 class="name">${name}</h2>
                    <div class="information">
                        <div class="column">
                            <div>Class -</div>
                            <div>Father's Name -</div>
                            <div>Adress -</div>
                            <div>Mobile -</div>
                            <div>DOB -</div>
                        </div>
                        <div class="column">
                            <div>${classname}</div>
                            <div>${father_name}</div>
                            <div>${address}</div>
                            <div>${mobile_no}</div>
                            <div>${dob}</div>
                        </div>
                    </div>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 150">
                        <path
                            fill="#0099ff"
                            fill-opacity="1"
                            d="M0,32L60,42.7C120,53,240,75,360,85.3C480,96,600,96,720,85.3C840,75,960,53,1080,37.3C1200,21,1320,11,1380,5.3L1440,0L1440,320L1380,320C1320,320,1200,320,1080,320C960,320,840,320,720,320C600,320,480,320,360,320C240,320,120,320,60,320L0,320Z"
                        ></path>
                    </svg>
                    <div class="text">
                        Principal Sign
                    </div>
                </div>`;
                            //insert the card with the updated information to cards div
                            document.querySelector(".cards").insertAdjacentHTML("afterbegin", card);
                            
                            let cardImage;
                           //download the image
                            /*domtoimage.toJpeg(document.querySelector(".card-div"), { quality: 0.95 }).then(function (dataUrl) {
                                var link = document.createElement("a");
                                //give your image name whatever you want it can be student name or mobile number
                                //***********
                                //if you dont want your user to download the file delete this three lines
                                //***********
                                link.download = "my-image-name.jpeg";
                                link.href = dataUrl;
                                link.click();
                                //fire the uploadTheCardFunction
                                uploadTheCard(dataUrl, name, father_name, classname, mobile_no, address, downloadURL);
                            });*/
                        });
                    }
                );
            }

            function uploadTheCard(dataUrl, name, father_name, classname, mobile_no, address, downloadURL) {
                //storing the cardImage on firebase
                const uploadTask = storageRef.putString(dataUrl, "data_url").then(function (snapshot) {
                    snapshot.ref.getDownloadURL().then(function (cardImage) {
                        //just console log of the url -- you can delete that console.log()
                        console.log("File cardImage available at", cardImage);
                        //this executes the sendmessage function with all the data
                        sendMessage(name, father_name, classname, mobile_no, address, downloadURL, cardImage);
                    });
                });
            }

            //trigger the download when user clicks the download button
            document.querySelector(".downloadButton").addEventListener("click", downloadImage);
function readFile() {
    var FR = new FileReader();
    
    FR.addEventListener("load", function(e) {
      firstFile64 = e.target.result;
    }); 
    
    FR.readAsDataURL( firstFile );
}
            //you can delete that part if you don't want the user to download the file using that button (downloading on submit will still work)
            function downloadImage() {
            	domtoimage.toJpeg(document.querySelector(".card-div"), { quality: 0.95 }).then(function (dataUrl) {
                                var link = document.createElement("a");
                                //give your image name whatever you want it can be student name or mobile number
                                //***********
                                //if you dont want your user to download the file delete this three lines
                                //***********
                                link.download = "my-image-name.jpeg";
                                link.href = dataUrl;
                                link.click();
                                //fire the uploadTheCardFunction
                                uploadTheCard(dataUrl, name, father_name, classname, mobile_no, address, downloadURL);
                            });
            }
        </script>
    </body>
</html>
